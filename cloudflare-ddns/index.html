<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="chrome=1">
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=referrer content="no-referrer">
<meta name=author content="Rohan Jain">
<meta name=description content="It is hard to maintain a regular internet uptime with home connections. 1/2 router re-connections per week can be fairly common. When that happens, the public IP changes with most ISPs. This can be annoying if you want access your computer remotely (possibly to SSH home). Dynamic DNS is a solution that exists to solve just that.
I maintain DNS entries for my domain at Clouflare. The latest version of ddclient supports Cloudflare API, which works well with my ArchLinux box.">
<meta property="og:title" content="Dynamic DNS with Cloudflare">
<meta property="og:description" content="It is hard to maintain a regular internet uptime with home connections. 1/2 router re-connections per week can be fairly common. When that happens, the public IP changes with most ISPs. This can be annoying if you want access your computer remotely (possibly to SSH home). Dynamic DNS is a solution that exists to solve just that.
I maintain DNS entries for my domain at Clouflare. The latest version of ddclient supports Cloudflare API, which works well with my ArchLinux box.">
<meta property="og:type" content="article">
<meta property="og:url" content="/cloudflare-ddns/"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2017-03-18T05:28:10+00:00">
<meta property="article:modified_time" content="2017-03-18T05:28:10+00:00">
<title>
Dynamic DNS with Cloudflare
</title>
<link rel=canonical href=/cloudflare-ddns/>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">
<link rel=stylesheet href=/css/reset.css>
<link rel=stylesheet href=/css/pygments.css>
<link rel=stylesheet href=/css/main.css>
<link rel=stylesheet href=/css/solarized.css>
<link rel=stylesheet href=/css/override.css>
<link rel="shortcut icon" href=/img/favicon.ico>
</head>
<body lang=en>
<section class=header>
<div class=container>
<div class=content>
<a href=/><img class=avatar src="https://gravatar.com/avatar/564e7aa79de47cdf3a094da1d4ac13cd?s=50" rcset="https://gravatar.com/avatar/564e7aa79de47cdf3a094da1d4ac13cd?s=100 2x, https://gravatar.com/avatar/564e7aa79de47cdf3a094da1d4ac13cd?s=150 3x, https://gravatar.com/avatar/564e7aa79de47cdf3a094da1d4ac13cd?s=200 4x"></a>
<a href=/><div class=name>Rohan Jain</div></a>
<nav>
<ul>
<li class=nav-home><a href=/><span>Home</span></a></li>
<li class=nav-about><a href=/about/><span>About</span></a></li>
</ul>
</nav>
</div>
</div>
</section>
<section class=icons>
<div class=container>
<div class=content>
<a href=//github.com/crodjer target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=//twitter.com/__crodjer__ target=_blank rel=noopener><img class=icon src=/img/twitter.svg alt=twitter></a>
<a href=//linkedin.com/in/crodjer target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a>
</div>
</div>
</section>
<section class="main post non-narrow zero-top-spacing">
<div class=container>
<div class=content>
<div class=front-matter>
<div class=title-container>
<div class=page-heading>
Dynamic DNS with Cloudflare
</div>
<div class=initials><a href=/></a></div>
</div>
<div class=meta>
<div class=date title="Sat Mar 18 2017 05:28:10 UTC">Mar 18, 2017</div>
<div class=reading-time><div class=middot></div>3 minutes read</div>
</div>
</div>
<div class=markdown>
<p>It is hard to maintain a regular internet uptime with home connections. 1/2
router re-connections per week can be fairly common. When that happens, the
public IP changes with most ISPs. This can be annoying if you want access your
computer remotely (possibly to SSH home). Dynamic DNS is a solution that exists
to solve just that.</p>
<p>I maintain DNS entries for my domain at
<a href=https://www.cloudflare.com/>Clouflare</a>. The latest version of
<a href=https://sourceforge.net/p/ddclient/wiki/Home/><code>ddclient</code></a> supports Cloudflare
API, which works well with my ArchLinux box. But ddclient bundled with Raspbian,
is yet to get that update. Cloudflare&rsquo;s API is fairly straight forward, so I
decided to use a curl/systemd based solution on my RaspberryPi.</p>
<h1 id=configuration-information>Configuration information</h1>
<p>If you too want to set Dynamic DNS with Cloudflare, you need to acquire some
configuration information first:</p>
<h2 id=cloudflare-configuration-details>Cloudflare configuration details</h2>
<ul>
<li>
<p><code>DNS Zone</code><br>
You can get it by visiting the overview page of Cloudflare dashboard (called
Zone ID):
<a href=https://www.cloudflare.com/a/overview/>https://www.cloudflare.com/a/overview/</a></p>
</li>
<li>
<p><code>Auth Email</code>: This is your cloudflare account email.</p>
</li>
<li>
<p><code>Auth Key</code>: This is your <em>Global API Key</em> under Cloudflare account settings:
<a href=https://www.cloudflare.com/a/account/my-account>https://www.cloudflare.com/a/account/my-account</a></p>
</li>
<li>
<p><code>IDENTIFIER</code><br>
To get the identifier, you need to first set an A record for the subdomain you
want to manage with Dynamic DNS. Then, plug in the subdomain in this curl
query to obtain the identifier:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>curl <span class=s2>&#34;https://api.cloudflare.com/client/v4/zones/&lt;your-dns-zone&gt;/dns_records?name=&lt;subdomain&gt;.&lt;your-domain&gt;&#34;</span> <span class=se>\
</span><span class=se></span>     --silent -X GET <span class=se>\
</span><span class=se></span>     -H <span class=s2>&#34;X-Auth-Email: &lt;cloudflare-auth-email&gt;&#34;</span> <span class=se>\
</span><span class=se></span>     -H <span class=s2>&#34;X-Auth-Key: &lt;cloudflare-auth-key&gt;&#34;</span> <span class=se>\
</span><span class=se></span>     -H <span class=s2>&#34;Content-Type: application/json&#34;</span> 
</code></pre></div></li>
</ul>
<h2 id=ip-address>IP Address</h2>
<p>I use <code>dig</code> with OpenDNS to get the current public IP and
<a href=https://www.ipify.org/>https://www.ipify.org/</a> as a fallback if <code>dig</code> isn&rsquo;t installed. Using <code>dig</code> is
faster though and you can install it via <code>dnsutils</code> (available as an official
package on most systems).</p>
<h1 id=the-script>The script</h1>
<p>All the above information can now be plugged in this bash script to update the
DNS entry on Cloudflare. I placed it at <code>/usr/local/bin/cloudflare-ddns.sh</code></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1>#/usr/bin/env sh</span>

<span class=c1># Get the Zone ID from: https://www.cloudflare.com/a/overview/&lt;your-domain&gt;</span>
<span class=nv>DNS_ZONE</span><span class=o>=</span>&lt;your-dns-zone&gt;

<span class=c1># Get the existing identifier for DNS entry:</span>
<span class=c1># https://api.cloudflare.com/#dns-records-for-a-zone-list-dns-records</span>
<span class=nv>IDENTIFIER</span><span class=o>=</span>&lt;your-domain-dns-entry-identifier&gt;

<span class=c1># Get these from: https://www.cloudflare.com/a/account/my-account</span>
<span class=nv>AUTH_EMAIL</span><span class=o>=</span>&lt;cloudflare-auth-email&gt;
<span class=nv>AUTH_KEY</span><span class=o>=</span>&lt;cloudflare-auth-key&gt;

<span class=c1># Desired domain name</span>
<span class=nv>DOMAIN_NAME</span><span class=o>=</span><span class=s2>&#34;&lt;subdomain&gt;.&lt;your-domain&gt;&#34;</span>

<span class=c1># Get previous IP address</span>
<span class=nv>_PREV_IP_FILE</span><span class=o>=</span><span class=s2>&#34;/tmp/public-ip.txt&#34;</span>
<span class=nv>_PREV_IP</span><span class=o>=</span><span class=k>$(</span>cat <span class=nv>$_PREV_IP_FILE</span> <span class=p>&amp;</span>&gt; /dev/null<span class=k>)</span>

<span class=c1># Install `dig` via `dnsutils` for faster IP lookup.</span>
<span class=nb>command</span> -v dig <span class=p>&amp;</span>&gt; /dev/null <span class=o>&amp;&amp;</span> <span class=o>{</span>
    <span class=nv>_IP</span><span class=o>=</span><span class=k>$(</span>dig +short myip.opendns.com @resolver1.opendns.com<span class=k>)</span>
<span class=o>}</span> <span class=o>||</span> <span class=o>{</span>
    <span class=nv>_IP</span><span class=o>=</span><span class=k>$(</span>curl --silent https://api.ipify.org<span class=k>)</span>
<span class=o>}</span> <span class=o>||</span> <span class=o>{</span>
    <span class=nb>exit</span> <span class=m>1</span>
<span class=o>}</span>

<span class=c1># If new/previous IPs match, no need for an update.</span>
<span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$_IP</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=nv>$_PREV_IP</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
    <span class=nb>exit</span> <span class=m>0</span>
<span class=k>fi</span>

<span class=nv>_UPDATE</span><span class=o>=</span><span class=k>$(</span>cat <span class=s>&lt;&lt;EOF
</span><span class=s>{ &#34;type&#34;: &#34;A&#34;,
</span><span class=s>  &#34;name&#34;: &#34;$DOMAIN_NAME&#34;,
</span><span class=s>  &#34;content&#34;: &#34;$_IP&#34;,
</span><span class=s>  &#34;ttl&#34;: 120,
</span><span class=s>  &#34;proxied&#34;: false }
</span><span class=s>EOF</span>
<span class=k>)</span>

curl <span class=s2>&#34;https://api.cloudflare.com/client/v4/zones/</span><span class=nv>$DNS_ZONE</span><span class=s2>/dns_records/</span><span class=nv>$IDENTIFIER</span><span class=s2>&#34;</span> <span class=se>\
</span><span class=se></span>     --silent <span class=se>\
</span><span class=se></span>     -X PUT <span class=se>\
</span><span class=se></span>     -H <span class=s2>&#34;Content-Type: application/json&#34;</span> <span class=se>\
</span><span class=se></span>     -H <span class=s2>&#34;X-Auth-Email: </span><span class=nv>$AUTH_EMAIL</span><span class=s2>&#34;</span> <span class=se>\
</span><span class=se></span>     -H <span class=s2>&#34;X-Auth-Key: </span><span class=nv>$AUTH_KEY</span><span class=s2>&#34;</span> <span class=se>\
</span><span class=se></span>     -d <span class=s2>&#34;</span><span class=nv>$_UPDATE</span><span class=s2>&#34;</span> &gt; /tmp/cloudflare-ddns-update.json <span class=o>&amp;&amp;</span> <span class=se>\
</span><span class=se></span>     <span class=nb>echo</span> <span class=nv>$_IP</span> &gt; <span class=nv>$_PREV_IP_FILE</span>
</code></pre></div><p>Try running <code>cloudflare-ddns.sh</code> to see if DNS records get updated on
Cloudflare. For debugging purposes, I store the Cloudflare response at
<code>/tmp/cloudflare-ddns-update.json</code>.</p>
<h1 id=systemd>Systemd</h1>
<p>We&rsquo;ll automate this execution by writing a systemd service and a timer.</p>
<h2 id=configuring-the-service>Configuring the service</h2>
<p>My systemd service unit looks like this:
<code>/etc/systemd/system/cloudflare-ddns.service</code></p>
<pre tabindex=0><code>[Unit]
Description=Update DNS entry for this host to current IP

[Service]
Type=oneshot
ExecStart=/bin/sh /usr/local/bin/cloudflare-ddns.sh
</code></pre><p>Test the service by running:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo systemctl start cloudflare-ddns.service
<span class=c1># Check the results:</span>
sudo journalctl -u cloudflare-ddns
</code></pre></div><h2 id=setting-up-a-timer>Setting up a timer</h2>
<p>Set up a timer, so that DNS update is attempted every 2 minutes:
<code>/etc/systemd/system/cloudflare-ddns.timer</code></p>
<pre tabindex=0><code>[Unit]
Description=Update DNS entry in cloudflare every 2 minutes

[Timer]
OnBootSec=1min
OnCalendar=*:0/2
Unit=cloudflare-ddns.service

[Install]
WantedBy=basic.target
</code></pre><p>To enable the timer, run:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>sudo systemctl <span class=nb>enable</span> cloudflare-ddns.timer
</code></pre></div><p>And that&rsquo;s it, now the system&rsquo;s IP will be kept up to date (within 2 minutes)
for remote access.</p>
<br>
<p class=back-to-posts><a href=/blog>Back to posts</a></p>
</div>
<br>
<div class=disqus>
</div>
</div>
</div>
</section>
<script data-goatcounter=https://t.rohanjain.in/count async src=//t.rohanjain.in/count.js></script>
<noscript>
<img src="https://t.rohanjain.in/count?p=/test-noscript">
</noscript>
</body>
</html>