<!doctype html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="Rohan Jain"><meta name=description content="Dynamic DNS with Cloudflare | Rohan's Personal Web Blog."><meta property="og:title" content="Dynamic DNS with Cloudflare"><meta property="og:type" content="article"><meta property="article:published_time" content="2017-03-18T05:28:10+00:00"><meta property="article:modified_time" content="2017-03-18T05:28:10+00:00"><title>Dynamic DNS with Cloudflare</title><link rel=canonical href=/cloudflare-ddns/><link rel=stylesheet href=/css/main.min.afafd1394edb70a0fd8ac692cf75af36bb2b1c76a02b6301f05c31e73aea3fca.css><link rel="shortcut icon" href=/img/favicon.ico><script>let FF_FOUC_FIX</script></head><body lang=en><header><a href=/>The Perpetual Amateur</a><nav><ul><li><a href=/>Home</a></li><li><a href=/about/>About</a></li></ul></nav></header><main><article><header><h1>Dynamic DNS with Cloudflare</h1><small><time datetime=2017-03-18 title='Sat Mar 18 2017 05:28:10 UTC'>Mar 18, 2017</time>
| 3 minutes read</small></header><p>It is hard to maintain a regular internet uptime with home connections. 1/2
router re-connections per week can be fairly common. When that happens, the
public IP changes with most ISPs. This can be annoying if you want access your
computer remotely (possibly to SSH home). Dynamic DNS is a solution that exists
to solve just that.</p><p>I maintain DNS entries for my domain at
<a href=https://www.cloudflare.com/>Clouflare</a>. The latest version of
<a href=https://sourceforge.net/p/ddclient/wiki/Home/><code>ddclient</code></a> supports Cloudflare
API, which works well with my ArchLinux box. But ddclient bundled with Raspbian,
is yet to get that update. Cloudflare&rsquo;s API is fairly straight forward, so I
decided to use a curl/systemd based solution on my RaspberryPi.</p><h2 id=configuration-information><a class=heading-anchor href=#configuration-information aria-label="Permalink to Configuration information">§</a>
Configuration information</h2><p>If you too want to set Dynamic DNS with Cloudflare, you need to acquire some
configuration information first:</p><h3 id=cloudflare-configuration-details><a class=heading-anchor href=#cloudflare-configuration-details aria-label="Permalink to Cloudflare configuration details">§</a>
Cloudflare configuration details</h3><ul><li><p><code>DNS Zone</code>
You can get it by visiting the overview page of Cloudflare dashboard (called
Zone ID):
<code>https://www.cloudflare.com/a/overview/&lt;your-domain></code></p></li><li><p><code>Auth Email</code>: This is your cloudflare account email.</p></li><li><p><code>Auth Key</code>: This is your <em>Global API Key</em> under Cloudflare account settings:
<a href=https://www.cloudflare.com/a/account/my-account>https://www.cloudflare.com/a/account/my-account</a></p></li><li><p><code>IDENTIFIER</code>
To get the identifier, you need to first set an A record for the subdomain you
want to manage with Dynamic DNS. Then, plug in the subdomain in this curl
query to obtain the identifier:</p><pre><code class=language-bash>curl &quot;https://api.cloudflare.com/client/v4/zones/&lt;your-dns-zone&gt;/dns_records?name=&lt;subdomain&gt;.&lt;your-domain&gt;&quot; \
     --silent -X GET \
     -H &quot;X-Auth-Email: &lt;cloudflare-auth-email&gt;&quot; \
     -H &quot;X-Auth-Key: &lt;cloudflare-auth-key&gt;&quot; \
     -H &quot;Content-Type: application/json&quot;
</code></pre></li></ul><h3 id=ip-address><a class=heading-anchor href=#ip-address aria-label="Permalink to IP Address">§</a>
IP Address</h3><p>I use <code>dig</code> with OpenDNS to get the current public IP and
<a href=https://www.ipify.org/>https://www.ipify.org/</a> as a fallback if <code>dig</code> isn&rsquo;t installed. Using <code>dig</code> is
faster though and you can install it via <code>dnsutils</code> (available as an official
package on most systems).</p><h2 id=the-script><a class=heading-anchor href=#the-script aria-label="Permalink to The script">§</a>
The script</h2><p>All the above information can now be plugged in this bash script to update the
DNS entry on Cloudflare. I placed it at <code>/usr/local/bin/cloudflare-ddns.sh</code></p><pre><code class=language-bash>#/usr/bin/env sh

# Get the Zone ID from: https://www.cloudflare.com/a/overview/&lt;your-domain&gt;
DNS_ZONE=&lt;your-dns-zone&gt;

# Get the existing identifier for DNS entry:
# https://api.cloudflare.com/#dns-records-for-a-zone-list-dns-records
IDENTIFIER=&lt;your-domain-dns-entry-identifier&gt;

# Get these from: https://www.cloudflare.com/a/account/my-account
AUTH_EMAIL=&lt;cloudflare-auth-email&gt;
AUTH_KEY=&lt;cloudflare-auth-key&gt;

# Desired domain name
DOMAIN_NAME=&quot;&lt;subdomain&gt;.&lt;your-domain&gt;&quot;

# Get previous IP address
_PREV_IP_FILE=&quot;/tmp/public-ip.txt&quot;
_PREV_IP=$(cat $_PREV_IP_FILE &amp;&gt; /dev/null)

# Install `dig` via `dnsutils` for faster IP lookup.
command -v dig &amp;&gt; /dev/null &amp;&amp; {
    _IP=$(dig +short myip.opendns.com @resolver1.opendns.com)
} || {
    _IP=$(curl --silent https://api.ipify.org)
} || {
    exit 1
}

# If new/previous IPs match, no need for an update.
if [ &quot;$_IP&quot; = &quot;$_PREV_IP&quot; ]; then
    exit 0
fi

_UPDATE=$(cat &lt;&lt;EOF
{ &quot;type&quot;: &quot;A&quot;,
  &quot;name&quot;: &quot;$DOMAIN_NAME&quot;,
  &quot;content&quot;: &quot;$_IP&quot;,
  &quot;ttl&quot;: 120,
  &quot;proxied&quot;: false }
EOF
)

curl &quot;https://api.cloudflare.com/client/v4/zones/$DNS_ZONE/dns_records/$IDENTIFIER&quot; \
     --silent \
     -X PUT \
     -H &quot;Content-Type: application/json&quot; \
     -H &quot;X-Auth-Email: $AUTH_EMAIL&quot; \
     -H &quot;X-Auth-Key: $AUTH_KEY&quot; \
     -d &quot;$_UPDATE&quot; &gt; /tmp/cloudflare-ddns-update.json &amp;&amp; \
     echo $_IP &gt; $_PREV_IP_FILE
</code></pre><p>Try running <code>cloudflare-ddns.sh</code> to see if DNS records get updated on
Cloudflare. For debugging purposes, I store the Cloudflare response at
<code>/tmp/cloudflare-ddns-update.json</code>.</p><h2 id=systemd><a class=heading-anchor href=#systemd aria-label="Permalink to Systemd">§</a>
Systemd</h2><p>We&rsquo;ll automate this execution by writing a systemd service and a timer.</p><h3 id=configuring-the-service><a class=heading-anchor href=#configuring-the-service aria-label="Permalink to Configuring the service">§</a>
Configuring the service</h3><p>My systemd service unit looks like this:
<code>/etc/systemd/system/cloudflare-ddns.service</code></p><pre><code>[Unit]
Description=Update DNS entry for this host to current IP

[Service]
Type=oneshot
ExecStart=/bin/sh /usr/local/bin/cloudflare-ddns.sh
</code></pre><p>Test the service by running:</p><pre><code class=language-bash>sudo systemctl start cloudflare-ddns.service
# Check the results:
sudo journalctl -u cloudflare-ddns
</code></pre><h3 id=setting-up-a-timer><a class=heading-anchor href=#setting-up-a-timer aria-label="Permalink to Setting up a timer">§</a>
Setting up a timer</h3><p>Set up a timer, so that DNS update is attempted every 2 minutes:
<code>/etc/systemd/system/cloudflare-ddns.timer</code></p><pre><code>[Unit]
Description=Update DNS entry in cloudflare every 2 minutes

[Timer]
OnBootSec=1min
OnCalendar=*:0/2
Unit=cloudflare-ddns.service

[Install]
WantedBy=basic.target
</code></pre><p>To enable the timer, run:</p><pre><code class=language-bash>sudo systemctl enable cloudflare-ddns.timer
</code></pre><p>And that&rsquo;s it, now the system&rsquo;s IP will be kept up to date (within 2 minutes)
for remote access.</p></article></main><footer><a href=/blog>All Posts</a>
<a href=//github.com/crodjer target=_blank rel=noopener>Github</a>
<a href=//linkedin.com/in/crodjer target=_blank rel=noopener>Linkedin</a>
<a href=//twitter.com/__crodjer__ target=_blank rel=noopener>Twitter</a></footer><script data-goatcounter=https://t.rohanjain.in/count async src=/js/count.min.4e3257a9873dba863f309fe89287c9f6e962d7be1758704f13b2608e58008e5f.js></script><noscript><img src="https://t.rohanjain.in/count?p=%2fcloudflare-ddns%2f&t=Dynamic%20DNS%20with%20Cloudflare"></noscript></body></html>